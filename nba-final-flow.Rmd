---
title: "NBA 2024 Final Process Mining"
author: "Author: Kurtis Smith"
date: "Published Date: TBC"
bibliography: references.bib
output: 
 html_document:
  fig_width: 10
  fig_height: 6
  theme: journal
---

## Project Introduction üëãüèΩ

Inspired by @PmInspiration, this blog will use R to explore process mining on a subject I'm fond of - basketball. I've played basketball all my life, although my failing left knee means I play infrequently in my older age.

I'll be analysing game 5 of the 2024 NBA final between Luka's Dallas Mavericks and Jayson's Boston Celtics. Well done Celtics üçÄ, who last won a championship 16 years ago. I'll avoid findings which could just as easily be found in a games summary statistics and focus on what unique insights process mining provides. Let's start with the data.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Load packages
library(tidyverse)
library(bupaverse)
library(processanimateR)
library(patchwork)
library(DT)
library(psmineR)

# Get data
nba_2024_g5_pm_data <- read_csv("./Data/nba-final-2024-game-5.csv", col_names = TRUE)

```

## Data Treatment

The data collation was a manual effort, a labour of love. After watching game 5 of the 2024 NBA finals I painstakingly noted down each activity along with the timestamp.

To add assurance to this data set I checked each activity available on [@nba.com/play-by-play](https://www.nba.com/game/dal-vs-bos-0042300405/play-by-play?period=All){.uri} matched on timestamp and cross checked the summary player stats against [@nba.com/box-score](https://www.nba.com/game/dal-vs-bos-0042300405/box-score?period=All){.uri}.

A few self imposed rules during data creation:

-   To define the process under analysis, one end to end run or "case" ends with a shot

-   At free throws the case ends at the last free throw attempt

-   Unless specified from the nba website I've timestamped at the beginning of each activity

## Create Eventlog

An eventlog in process mining is a structured collection of recorded events that represent the execution of activities usually within a business process, in this context, an NBA game.

It typically contains information such as the event type, timestamp, case identifier, and other relevant attributes, serving as the primary input for process mining techniques to discover, monitor, and improve actual processes.

```{r create_eventlog}

nba_final_g5_eventlog <-  nba_2024_g5_pm_data %>% 
 mutate(lifecycle_id = "complete", 
        timestamp = ymd_hms(paste0("20240617 ", timestamp))) %>% 
 eventlog(case_id = "case_id", 
          activity_id = "activity_id", 
          activity_instance_id = "seq", 
          lifecycle_id = "lifecycle_id", 
          timestamp = "timestamp", 
          resource_id = "resource_id", 
          order = "seq", 
          validate = TRUE)

```

## Analysis {.tabset}

### Control-Flow

Control flow in process mining refers to the sequence and decision points of activities within a process. This perspective explores the flow of the game.

#### Traces

Traces are the distinct processes of an eventlog, in this context, a play which starts post shot attempt until another shot attempt.

##### Coverage

Reviewing the trace coverage to cases let's us see if a team regularly uses the same plays throughout the case or if plays are infrequent.

```{r trace_coverage}

log_trace <- nba_final_g5_eventlog %>%
 trace_coverage("trace") %>% 
 plot()

united_log_trace <- nba_final_g5_eventlog %>%
 act_unite(pass = c("pass-to-assist", "pass", "pass-turnover", "pass-to-start-quarter"),
           dribble = c("dribble", "dribble-turnover"),
           rebound = c("defensive-rebound", "offensive-rebound"),
           shot = c("shot-miss", "shot-make")) %>% 
 trace_coverage("trace") %>% 
 plot()

 log_trace + united_log_trace

```

As the left plot displays a max relative frequency of 0.03, the plays of this game varied considerably. Even when grouping activities e.g. dribble and dribble-turnover both set as dribble, a max relative frequency of 0.06 as shown in the right plot.

With more detailed data around off the ball movements and data on many more games, perhaps you could use trace coverage analysis to: - See if what looks seemingly like a collect of passes and dribbles is a drawn up play which would in theory increase the relative frequency - Compare across teams and games to see if this metric shares patterns with tradition metrics i.e. win/loss, plus/minus etc

##### Team Trace Length

Reviewing the trace sizes for each team.

```{r trace_length}

shot_made_plot <- nba_final_g5_eventlog %>%
 filter_activity_presence("shot-make") %>%
 group_by(teams_play) %>%
 trace_length("log") %>%
 plot() +
 scale_y_continuous(limits = c(0, 18)) +
 labs(title = "Teams Traces by Shot Made")


shot_miss_plot <- nba_final_g5_eventlog %>%
 filter_activity_presence("shot-miss") %>%
 group_by(teams_play) %>%
 trace_length("log") %>%
 plot() +
 scale_y_continuous(limits = c(0, 18)) +
 labs(title = "Teams Traces by Shot Miss")

shot_made_plot + shot_miss_plot

```

All look similar except Dallas for plays which end in a miss. Lets look into this further by spliting Dallas traces by quarter.

```{r trace_sizes}

nba_final_g5_eventlog %>%
 filter(teams_play == "Dallas Mavericks") %>% 
 filter_activity_presence("shot-miss") %>%
 group_by(quarter) %>% 
 trace_length("log") %>%
 plot() 

```

The 4th quarter has higher average and max trace lengths at a time when they needed to make a push.

There could be multiple reasons as to why, perhaps Boston played brilliant defence forcing Dallas to pass more in order to shift the defence and make space.

Regardless this ran down the clock limiting the number of available opportunities to reduce the deficit.

Let's view that 4th quarter outlier process to see why.

```{r trace_outlier}

longest_trace <- nba_final_g5_eventlog %>%
 filter(teams_play == "Dallas Mavericks") %>%
 filter_activity_presence("shot-miss") %>%
 filter_trace_length(percentage = 0.01) %>% 
 count(case_id, sort = TRUE) %>% 
 head(1) %>% 
 pull(case_id)

nba_final_g5_eventlog %>%
 filter_case(cases = longest_trace) %>% 
 as.data.frame() %>% 
 select(case_id, seq, activity_id, player_team, teams_play) %>% 
 datatable(class = c("compact", "hover", "row-border"), 
           rownames = FALSE, 
           options = list(pageLength = 20))
 
```

This outlier is explained by how a play is defined by a shot attempt. Boston held position at the onset but turned over possession to Dallas, shortly after Dallas made a shot attempt.

#### Precedences

Reviewing the activity process matrix allows for investigation into antecedent and consequential activities. Each activity row will sum to 100%.

```{r precedence}

suppressMessages(
nba_final_g5_eventlog %>%
 process_matrix(type = frequency("relative-antecedent")) %>% 
 plot() +
 theme(legend.position = "top") +
 scale_fill_viridis_b(name = "Relative Antecedence", direction = -1)
)

```

Across the game \~70% of all passes were followed by a dribble whilst \~20% of the time it was followed by another pass. Additional data and further analysis could shed light on, if these figures typified finals or playing styles of NBA teams.

\~55% of the time a defensive rebound was followed by a dribble, and \~38% a pass. Your taught to grab the rebound and look for the outlet (at least in the United Kingdom) yet in this game the dribble was preferred. If you had distances you may look to investigate if a lack of outlet options was the reason or perhaps the rebound was caught closer to the 3pt line than under the rim so it made more sense to move the ball up the court for a fast break or at the very least avoid a 8 second violation.

### Performance

Performance analysis typically involves metrics such as time to complete activity, time in between each activity, and total time of process to understand the factors affecting process performance.

#### Throughput Time

This analysis is limited by the time stamps collected. If I had start and end times of each activity, more granular analysis could be performed. As it stands only total time across process is available, also know as throughput time.

```{r throughput}
suppressMessages(
throughput_make_plot <- nba_final_g5_eventlog %>% 
 group_by(teams_play) %>%
 filter_activity_presence("shot-make", method = "none") %>% 
 throughput_time("log", units = "secs") %>%
 plot() +
 scale_y_continuous(limits = c(0, 45)) +
 labs(title = "Teams Traces by Shot Make"))

suppressMessages(
throughput_miss_plot <- nba_final_g5_eventlog %>% 
 group_by(teams_play) %>%
 filter_activity_presence("shot-miss", method = "none") %>% 
 throughput_time("log", units = "secs") %>%
 plot() +
 scale_y_continuous(limits = c(0, 45)) +
 labs(title = "Teams Traces by Shot Miss"))

throughput_make_plot + throughput_miss_plot 

```

-   Bostons interquartile range is wider than Dallas's, 50% of Bostons plays are more varied in time than 50% of Dallas'.

-   For shots made by Dallas the interquartile range is half that of Boston. 50% of Dallas's plays were quick, perhaps rushed due to score deficit.

#### Process Map

Process mining isn't complete without a process map. Split by team plays, you could dig for many insights looking across both maps.

##### Boston Celtics

```{r process_map_boston}

nba_final_g5_eventlog %>%
 filter(teams_play == "Boston Celtics") %>% 
 process_map(
  type_nodes = frequency("absolute"),
  type_edges = performance(mean, "secs"),
  rankdir = "TB"
 )

```

##### Dallas Mavericks

```{r process_map_dallas}

nba_final_g5_eventlog %>%
 filter(teams_play == "Dallas Mavericks") %>% 
 process_map(
  type_nodes = frequency("absolute"),
  type_edges = performance(mean, "secs"),
  rankdir = "TB"
 )

```

A few noteworthy insights:

-   Celtics were more industrious than Dallas. Having completed more passes, dribbles, rebounds, blocks etc

-   Boston were 1 second quicker on average to make a shot attempt after a defensive rebound.

-   Both teams passed the ball with similar average times: Boston with 1.2 seconds and Dallas 1.51 seconds, for passes not leading to an assist. Boston 2.31 seconds and Dallas 2.5 seconds for passes leading to an assist. In both cases Boston were on average quicker and sharper in moving the ball.

#### Spectra

Referenced in [@bupaverse_spectrum](https://bupaverse.github.io/docs/performance_spectrum.html){.uri}, @inproceedings provides another avenue to analyse performance. What the authors term "performance spectra" defined as "The Performance Spectrum is a fully detailed data structure and visualization of all cases over all segments over time" provides a taxonomy of performance patterns.

```{r spectra}

suppressMessages(
nba_final_g5_eventlog %>% 
 ps_detailed(segment_coverage = 0.15, classification = "teams_play") + 
 scale_colour_viridis_d()
)

```

I've opted for 15% coverage of plays (or cases) which contain the activity pairs as most would be sparse and beyond evaluating.

In line with the taxonomy, this event has generally 2 elementary patterns for the 15% coverage:

-   For dribble to pass and vice versa: The pattern follows a **single segment** with **globally occurring** instances, with **regular repetitions**, and a **continuous** workload across the course of the event, the full 45 mins.

-   For the rest of the pairwise segments had a similar taxonomy with a **sparse** workload.

Interesting analysis when applied to administrative data as is the case for @inproceedings. However, applied to this dataset offers little more. If this dataset included off the ball movement and/or multiple games, perhaps analysis of performance spectra would be more fruitful.

### Organisational

Organisational analysis refers to the examination of the social and organisational aspects of a business process, such as the resources, responsibilities, and interactions of the individuals involved.

#### Resource Industry

Looking at the top 10 industrious players, the players with higher frequency of activities. This is were you would expect to see your stars.

```{r industry}

nba_final_g5_eventlog %>% 
 resource_frequency(level = "resource") %>%
 head(10) %>% 
 plot()

```

As you would expect, Tatum, Doncic, and Brown rank in the top 3. Kyrie was not as involved as Dallas would have liked. Boston hold 4 of the 5 top spots, they certainly brought the game to Dallas.

#### Specialisation

```{r specialisation}

nba_final_g5_eventlog %>% 
 group_by(player_team) %>% 
 resource_frequency(level = "resource-activity") %>%
 filter(!resource_id %in% c("Boston Celtics", "Dallas Mavericks"), 
        absolute > 1) %>%
 plot()

```

One game doesn't make a specialist but for the purposes of exploration let's see who was a one-game specialist, who excels at a type of activity. Note, I've removed any activities that happended once plot dimensions and make it easy viewing.

A few noteworthy insights

-   There are more Dallas players than Boston, the specialisation of activities was spread wider for Dallas.

-   Luka held the pass master title for Dallas and was certainly his teams passing specialist whilst Boston shared that specialisation across 4 players.

-   Luka specialised in defensive rebound for his team as well as passing, were as Boston shared this responsibility across 4 players.

Although there were more Dallas specialists, Luka was the main specialist in passing, and defensive rebounded comparative to his team whilst Boston often had several specialists in any given activity. This would have hindered Dallas when Luka was subbed and benefited Boston during bench rotation.

## Conclusion

Improvements

Automate data collection Have all 5 games in the data set Have included, as an activity, when players don't move with the ball. This would have been interesting to delve into. I suspect you would see the time Celtics held the ball increase in quarter 4 as they attempt to run the clock.

## Acknowledgements

Packages and package maintainer(s):

-   tidyverse \| Hadley Wickham
-   bupaverse \| Gert Janssenswillen

## References
